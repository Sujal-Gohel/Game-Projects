[gd_scene load_steps=65 format=3 uid="uid://c7wpweohr6enw"]

[ext_resource type="Texture2D" uid="uid://llvbwlaxsg4j" path="res://Assets/Enemy/Golem/Golem_1_attack.png" id="2_gx76c"]
[ext_resource type="Texture2D" uid="uid://dvvaix8sh6mcl" path="res://Assets/Enemy/Golem/Golem_1_hurt.png" id="3_pqgp3"]
[ext_resource type="Texture2D" uid="uid://bijew30gtkdod" path="res://Assets/Enemy/Golem/Golem_1_die.png" id="4_4ad2a"]
[ext_resource type="Texture2D" uid="uid://fob5dlvbx53n" path="res://Assets/Enemy/Golem/Golem_1_idle.png" id="5_kiqm3"]
[ext_resource type="Texture2D" uid="uid://64deno1g0slf" path="res://Assets/Enemy/Golem/Golem_1_walk.png" id="6_6j3ko"]
[ext_resource type="Script" uid="uid://lj6lfmj3y53e" path="res://Scripts/enemy_states_control.gd" id="7_4ad2a"]
[ext_resource type="Script" uid="uid://cc14xsoe5v1fb" path="res://Scripts/Enemy/States/idle_state.gd" id="8_kiqm3"]
[ext_resource type="Script" uid="uid://7gxeh86260jy" path="res://Scripts/Enemy/States/walking_state.gd" id="9_2chwy"]
[ext_resource type="Script" uid="uid://bm6iwqvilif81" path="res://Scripts/Enemy/States/attack_state.gd" id="9_6j3ko"]
[ext_resource type="Script" uid="uid://cy5rken345j3x" path="res://Scripts/Enemy/gravity.gd" id="9_kiqm3"]
[ext_resource type="Script" uid="uid://5okxliqf83op" path="res://Scripts/finite_state_machine_controller.gd" id="11_2chwy"]

[sub_resource type="GDScript" id="GDScript_beese"]
script/source = "#class_name Enemy 
extends CharacterBody2D

enum States { Idle,Walk,Attack }

@onready var character: AnimatedSprite2D = $AnimatedSprite2D
@onready var timer: Timer = $Timer
#@onready var left_point: Marker2D = $\"../Limit/LeftPoint\"
#@onready var right_point: Marker2D = $\"../Limit/RightPoint\"
@onready var attack_cooldown: Timer = $AttackCooldown

@export var move_speed : float = 50
@export var chase_speed : float = 100
@export var left_point : Marker2D
@export var right_point : Marker2D
@export var health : float = 5
@export var damage : float = 1.2


var player : Player
var can_chase : bool = false
var enemy_state : States
var dir : int = 1
var chase_dir : int
var can_walk : bool = false
var go_to_spawn : bool = false
var can_attack : bool = false

func _physics_process(delta: float) -> void:
	#if !can_chase and !go_to_spawn and !can_attack:
		#enemy_idle(delta)
		##enemy_fall(delta)
		#enemy_walk(delta)
		#change_direction()
	#if can_chase and !can_attack:
		#enemy_chase(delta)
	#if go_to_spawn and !can_attack:
		#spawn_place()
	#if can_attack and !can_chase and !go_to_spawn :
		#enemy_attack(delta)
	#play_animation()
	#print(States.keys()[enemy_state])
	move_and_slide()

# STATES

#func enemy_fall(delta : float):
	#if !is_on_floor():
		#velocity += get_gravity() * delta

#func enemy_idle(delta : float) :
	#if is_on_floor():
		#enemy_state = States.Idle
		#velocity.x = move_toward(velocity.x , 0 , delta * 300)
#
#
#func enemy_walk(delta : float) :
	#if can_walk and enemy_state == States.Idle :
		#enemy_state = States.Walk
		#velocity.x = dir * move_speed
#
#func enemy_chase(delta : float) :
	#enemy_state = States.Walk
	#velocity.x = chase_dir * chase_speed
#
#func enemy_attack(delta : float) :
	#enemy_state = States.Attack
	#velocity.x = move_toward(velocity.x , 0 , 300)
	#if (character.frame == 7) :
		#player.player_hp -= damage

# OTHER FUNCTION

func play_animation():
	if enemy_state == States.Idle:
		character.play(\"idle\")
	if enemy_state == States.Walk:
		character.play(\"walk\")
	if enemy_state == States.Attack : 
		character.play(\"attack\")
		#print(\"attack\")

func change_direction():
	if position.x <= right_point.position.x and position.x <= left_point.position.x:
		dir = 1
	elif position.x >= left_point.position.x and position.x >= right_point.position.x:
		dir = -1
	character.flip_h = true if dir < 0 else false

func change_state():
	if enemy_state == States.Idle :
		can_walk = true 
	if enemy_state == States.Walk:
		can_walk = false

func spawn_place() :
	if position.x > right_point.position.x :
		dir = -1
	elif position.x < left_point.position.x :
		dir = 1
	velocity.x = dir * move_speed
	character.flip_h = true if dir < 0 else false
	if position.x < right_point.position.x and position.x > left_point.position.x:
		velocity.x = move_toward(velocity.x , 0 , 300 )
		go_to_spawn = false

# SIGNAL

func _on_timer_timeout() -> void:
	change_state()
	timer.wait_time = randf_range(1,3)

func left_player_detection_body_entered(body: Node2D) -> void:
	if body is Player :
		go_to_spawn = false
		player = body
		chase_dir = -1
		character.flip_h = true if chase_dir < 0 else false
		can_chase = true

func left_player_detection_body_exited(body: Node2D) -> void:
	if body is Player :
		chase_dir = 0
		go_to_spawn = true
		can_chase = false

func right_player_detection_body_entered(body: Node2D) -> void:
	if body is Player :
		go_to_spawn = false
		player = body
		chase_dir = 1
		character.flip_h = true if chase_dir < 0 else false
		can_chase = true

func right_player_detection_body_exited(body: Node2D) -> void:
	if body is Player :
		chase_dir = 0
		go_to_spawn = true
		can_chase = false


func _on_hitbox_body_entered(body: Node2D) -> void:
	if body is Player :
		can_chase = false
		can_attack = true

func _on_hitbox_body_exited(body: Node2D) -> void:
	if body is Player :
		can_chase = true
		can_attack = false

func _on_hurtbox_body_entered(body: Node2D) -> void:
	if body is Player :
		pass

func _on_hurtbox_body_exited(body: Node2D) -> void:
	if body is Player :
		pass
"

[sub_resource type="AtlasTexture" id="AtlasTexture_2chwy"]
atlas = ExtResource("2_gx76c")
region = Rect2(0, 0, 90, 64)

[sub_resource type="AtlasTexture" id="AtlasTexture_beese"]
atlas = ExtResource("2_gx76c")
region = Rect2(90, 0, 90, 64)

[sub_resource type="AtlasTexture" id="AtlasTexture_1vi6b"]
atlas = ExtResource("2_gx76c")
region = Rect2(180, 0, 90, 64)

[sub_resource type="AtlasTexture" id="AtlasTexture_r1w2j"]
atlas = ExtResource("2_gx76c")
region = Rect2(270, 0, 90, 64)

[sub_resource type="AtlasTexture" id="AtlasTexture_u4wq1"]
atlas = ExtResource("2_gx76c")
region = Rect2(360, 0, 90, 64)

[sub_resource type="AtlasTexture" id="AtlasTexture_5luce"]
atlas = ExtResource("2_gx76c")
region = Rect2(450, 0, 90, 64)

[sub_resource type="AtlasTexture" id="AtlasTexture_xmc1t"]
atlas = ExtResource("2_gx76c")
region = Rect2(540, 0, 90, 64)

[sub_resource type="AtlasTexture" id="AtlasTexture_d2jnu"]
atlas = ExtResource("2_gx76c")
region = Rect2(630, 0, 90, 64)

[sub_resource type="AtlasTexture" id="AtlasTexture_x4yp7"]
atlas = ExtResource("2_gx76c")
region = Rect2(720, 0, 90, 64)

[sub_resource type="AtlasTexture" id="AtlasTexture_tqvt7"]
atlas = ExtResource("2_gx76c")
region = Rect2(810, 0, 90, 64)

[sub_resource type="AtlasTexture" id="AtlasTexture_ijynf"]
atlas = ExtResource("2_gx76c")
region = Rect2(900, 0, 90, 64)

[sub_resource type="AtlasTexture" id="AtlasTexture_tj3on"]
atlas = ExtResource("3_pqgp3")
region = Rect2(0, 0, 90, 64)

[sub_resource type="AtlasTexture" id="AtlasTexture_gtqxs"]
atlas = ExtResource("3_pqgp3")
region = Rect2(90, 0, 90, 64)

[sub_resource type="AtlasTexture" id="AtlasTexture_x18n6"]
atlas = ExtResource("3_pqgp3")
region = Rect2(180, 0, 90, 64)

[sub_resource type="AtlasTexture" id="AtlasTexture_f3l8n"]
atlas = ExtResource("3_pqgp3")
region = Rect2(270, 0, 90, 64)

[sub_resource type="AtlasTexture" id="AtlasTexture_5rl8s"]
atlas = ExtResource("4_4ad2a")
region = Rect2(0, 0, 90, 64)

[sub_resource type="AtlasTexture" id="AtlasTexture_g6g8b"]
atlas = ExtResource("4_4ad2a")
region = Rect2(90, 0, 90, 64)

[sub_resource type="AtlasTexture" id="AtlasTexture_3nhpm"]
atlas = ExtResource("4_4ad2a")
region = Rect2(180, 0, 90, 64)

[sub_resource type="AtlasTexture" id="AtlasTexture_myvan"]
atlas = ExtResource("4_4ad2a")
region = Rect2(270, 0, 90, 64)

[sub_resource type="AtlasTexture" id="AtlasTexture_2u43t"]
atlas = ExtResource("4_4ad2a")
region = Rect2(360, 0, 90, 64)

[sub_resource type="AtlasTexture" id="AtlasTexture_fjqqt"]
atlas = ExtResource("4_4ad2a")
region = Rect2(450, 0, 90, 64)

[sub_resource type="AtlasTexture" id="AtlasTexture_rac3i"]
atlas = ExtResource("4_4ad2a")
region = Rect2(540, 0, 90, 64)

[sub_resource type="AtlasTexture" id="AtlasTexture_ifrnt"]
atlas = ExtResource("4_4ad2a")
region = Rect2(630, 0, 90, 64)

[sub_resource type="AtlasTexture" id="AtlasTexture_7ln3t"]
atlas = ExtResource("4_4ad2a")
region = Rect2(720, 0, 90, 64)

[sub_resource type="AtlasTexture" id="AtlasTexture_8kmt2"]
atlas = ExtResource("4_4ad2a")
region = Rect2(810, 0, 90, 64)

[sub_resource type="AtlasTexture" id="AtlasTexture_ss2dq"]
atlas = ExtResource("4_4ad2a")
region = Rect2(900, 0, 90, 64)

[sub_resource type="AtlasTexture" id="AtlasTexture_h48s5"]
atlas = ExtResource("4_4ad2a")
region = Rect2(990, 0, 90, 64)

[sub_resource type="AtlasTexture" id="AtlasTexture_k0qr5"]
atlas = ExtResource("4_4ad2a")
region = Rect2(1080, 0, 90, 64)

[sub_resource type="AtlasTexture" id="AtlasTexture_afa01"]
atlas = ExtResource("5_kiqm3")
region = Rect2(0, 0, 90, 64)

[sub_resource type="AtlasTexture" id="AtlasTexture_ivpvb"]
atlas = ExtResource("5_kiqm3")
region = Rect2(90, 0, 90, 64)

[sub_resource type="AtlasTexture" id="AtlasTexture_psgxv"]
atlas = ExtResource("5_kiqm3")
region = Rect2(180, 0, 90, 64)

[sub_resource type="AtlasTexture" id="AtlasTexture_phhfh"]
atlas = ExtResource("5_kiqm3")
region = Rect2(270, 0, 90, 64)

[sub_resource type="AtlasTexture" id="AtlasTexture_306ve"]
atlas = ExtResource("5_kiqm3")
region = Rect2(360, 0, 90, 64)

[sub_resource type="AtlasTexture" id="AtlasTexture_jgfhy"]
atlas = ExtResource("5_kiqm3")
region = Rect2(450, 0, 90, 64)

[sub_resource type="AtlasTexture" id="AtlasTexture_ee3hu"]
atlas = ExtResource("5_kiqm3")
region = Rect2(540, 0, 90, 64)

[sub_resource type="AtlasTexture" id="AtlasTexture_0prq8"]
atlas = ExtResource("5_kiqm3")
region = Rect2(630, 0, 90, 64)

[sub_resource type="AtlasTexture" id="AtlasTexture_r32c4"]
atlas = ExtResource("6_6j3ko")
region = Rect2(0, 0, 90, 64)

[sub_resource type="AtlasTexture" id="AtlasTexture_ecm5i"]
atlas = ExtResource("6_6j3ko")
region = Rect2(90, 0, 90, 64)

[sub_resource type="AtlasTexture" id="AtlasTexture_di2pg"]
atlas = ExtResource("6_6j3ko")
region = Rect2(180, 0, 90, 64)

[sub_resource type="AtlasTexture" id="AtlasTexture_rfkcq"]
atlas = ExtResource("6_6j3ko")
region = Rect2(270, 0, 90, 64)

[sub_resource type="AtlasTexture" id="AtlasTexture_ef7tc"]
atlas = ExtResource("6_6j3ko")
region = Rect2(360, 0, 90, 64)

[sub_resource type="AtlasTexture" id="AtlasTexture_qudq3"]
atlas = ExtResource("6_6j3ko")
region = Rect2(450, 0, 90, 64)

[sub_resource type="AtlasTexture" id="AtlasTexture_7a374"]
atlas = ExtResource("6_6j3ko")
region = Rect2(540, 0, 90, 64)

[sub_resource type="AtlasTexture" id="AtlasTexture_g8ggl"]
atlas = ExtResource("6_6j3ko")
region = Rect2(630, 0, 90, 64)

[sub_resource type="AtlasTexture" id="AtlasTexture_nte12"]
atlas = ExtResource("6_6j3ko")
region = Rect2(720, 0, 90, 64)

[sub_resource type="AtlasTexture" id="AtlasTexture_5srat"]
atlas = ExtResource("6_6j3ko")
region = Rect2(810, 0, 90, 64)

[sub_resource type="SpriteFrames" id="SpriteFrames_m7dqh"]
animations = [{
"frames": [{
"duration": 1.0,
"texture": SubResource("AtlasTexture_2chwy")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_beese")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_1vi6b")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_r1w2j")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_u4wq1")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_5luce")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_xmc1t")
}, {
"duration": 0.3,
"texture": SubResource("AtlasTexture_d2jnu")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_x4yp7")
}, {
"duration": 5.0,
"texture": SubResource("AtlasTexture_tqvt7")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_ijynf")
}],
"loop": false,
"name": &"attack",
"speed": 12.0
}, {
"frames": [{
"duration": 1.0,
"texture": SubResource("AtlasTexture_tj3on")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_gtqxs")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_x18n6")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_f3l8n")
}],
"loop": false,
"name": &"damage",
"speed": 10.0
}, {
"frames": [{
"duration": 1.0,
"texture": SubResource("AtlasTexture_5rl8s")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_g6g8b")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_3nhpm")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_myvan")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_2u43t")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_fjqqt")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_rac3i")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_ifrnt")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_7ln3t")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_8kmt2")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_ss2dq")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_h48s5")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_k0qr5")
}],
"loop": false,
"name": &"die",
"speed": 12.0
}, {
"frames": [{
"duration": 1.0,
"texture": SubResource("AtlasTexture_afa01")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_ivpvb")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_psgxv")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_phhfh")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_306ve")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_jgfhy")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_ee3hu")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_0prq8")
}],
"loop": true,
"name": &"idle",
"speed": 12.0
}, {
"frames": [{
"duration": 1.0,
"texture": SubResource("AtlasTexture_r32c4")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_ecm5i")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_di2pg")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_rfkcq")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_ef7tc")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_qudq3")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_7a374")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_g8ggl")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_nte12")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_5srat")
}],
"loop": true,
"name": &"walk",
"speed": 12.0
}]

[sub_resource type="CircleShape2D" id="CircleShape2D_gx76c"]
radius = 12.51

[sub_resource type="RectangleShape2D" id="RectangleShape2D_gx76c"]
size = Vector2(60, 120)

[sub_resource type="RectangleShape2D" id="RectangleShape2D_pqgp3"]
size = Vector2(60, 120)

[sub_resource type="RectangleShape2D" id="RectangleShape2D_4ad2a"]
size = Vector2(60, 60)

[sub_resource type="RectangleShape2D" id="RectangleShape2D_kiqm3"]
size = Vector2(60, 60)

[node name="Enemy" type="CharacterBody2D"]
scale = Vector2(0.8, 0.8)
collision_layer = 2
collision_mask = 5
script = SubResource("GDScript_beese")

[node name="Timer" type="Timer" parent="."]
autostart = true

[node name="AnimatedSprite2D" type="AnimatedSprite2D" parent="."]
position = Vector2(0, -32)
sprite_frames = SubResource("SpriteFrames_m7dqh")
animation = &"attack"
autoplay = "idle"
frame = 7

[node name="CollisionShape2D" type="CollisionShape2D" parent="."]
position = Vector2(0, -15)
shape = SubResource("CircleShape2D_gx76c")

[node name="LeftPlayerDetection" type="Area2D" parent="."]

[node name="LeftDetection" type="CollisionShape2D" parent="LeftPlayerDetection"]
position = Vector2(-90, -30)
rotation = 1.5708
shape = SubResource("RectangleShape2D_gx76c")
debug_color = Color(1, 0, 0, 0.419608)

[node name="RightPlayerDetection" type="Area2D" parent="."]

[node name="RightDetection" type="CollisionShape2D" parent="RightPlayerDetection"]
position = Vector2(90, -30)
rotation = 1.5708
shape = SubResource("RectangleShape2D_pqgp3")
debug_color = Color(1, 0, 0, 0.419608)

[node name="hurtbox" type="Area2D" parent="."]

[node name="CollisionShape2D" type="CollisionShape2D" parent="hurtbox"]
position = Vector2(0, -30)
rotation = 1.5708
shape = SubResource("RectangleShape2D_4ad2a")
debug_color = Color(0, 1, 0, 0.419608)

[node name="hitbox" type="Area2D" parent="."]

[node name="CollisionShape2D" type="CollisionShape2D" parent="hitbox"]
position = Vector2(0, -30)
rotation = 1.5708
shape = SubResource("RectangleShape2D_kiqm3")
debug_color = Color(0, 1, 0, 0.419608)

[node name="FiniteStateMachine" type="Node" parent="."]
script = ExtResource("11_2chwy")

[node name="StateControl" type="Node" parent="." node_paths=PackedStringArray("initial_state")]
script = ExtResource("7_4ad2a")
initial_state = NodePath("Idle")

[node name="Idle" type="Node" parent="StateControl" node_paths=PackedStringArray("character", "animated_body")]
script = ExtResource("8_kiqm3")
character = NodePath("../..")
animated_body = NodePath("../../AnimatedSprite2D")

[node name="Attack" type="Node" parent="StateControl"]
script = ExtResource("9_6j3ko")

[node name="Walk" type="Node" parent="StateControl" node_paths=PackedStringArray("character", "animated_body")]
script = ExtResource("9_2chwy")
character = NodePath("../..")
animated_body = NodePath("../../AnimatedSprite2D")

[node name="Gravity" type="Node" parent="."]
script = ExtResource("9_kiqm3")

[connection signal="timeout" from="Timer" to="FiniteStateMachine" method="_on_timer_timeout"]
[connection signal="body_entered" from="LeftPlayerDetection" to="." method="left_player_detection_body_entered"]
[connection signal="body_exited" from="LeftPlayerDetection" to="." method="left_player_detection_body_exited"]
[connection signal="body_entered" from="RightPlayerDetection" to="." method="right_player_detection_body_entered"]
[connection signal="body_exited" from="RightPlayerDetection" to="." method="right_player_detection_body_exited"]
[connection signal="body_entered" from="hurtbox" to="." method="_on_hurtbox_body_entered"]
[connection signal="body_exited" from="hurtbox" to="." method="_on_hurtbox_body_exited"]
[connection signal="body_entered" from="hitbox" to="." method="_on_hitbox_body_entered"]
[connection signal="body_exited" from="hitbox" to="." method="_on_hitbox_body_exited"]
